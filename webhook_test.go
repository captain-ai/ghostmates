package ghostmates

import (
	"bytes"
	"encoding/json"
	"fmt"
	"io/ioutil"
	"net/http"
	"net/http/httptest"
	"strings"
	"testing"
	"time"
)

var (
	TestDeliveryPayloads = []string{
		// taken from the payloads received from an adhoc endpoint and the current test payload
		// this is jank but until a better solution arises for testing a webhook locally, it's the best we've got
		`{"kind": "event.courier_update", "location": {"lat": 40.7741693086343, "lng": -73.99721718233224}, "created": "2015-05-24T19:47:17Z", "live_mode": false, "delivery_id": "del_KL7ebUwT4XjFKF", "data": {"status": "pickup", "dropoff": {"phone_number": "620-222-3333", "name": "Dropoff spot, Dropoff LLC", "notes": "Dropoff notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "updated": "2015-05-24T19:47:17Z", "fee": 1325, "quote_id": "dqt_KL7ebISPfySYZ-", "complete": false, "courier": {"phone_number": null, "img_href": "https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg", "vehicle_type": "scooter", "location": {"lat": 40.7741693086343, "lng": -73.99721718233224}, "name": "Pikachu R."}, "created": "2015-05-24T19:46:38Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "555-222-3333", "name": "Pickup spot, Pickup LLC", "notes": "Pickup notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL7ebUwT4XjFKF", "dropoff_deadline": "2015-05-24T20:46:37Z", "related_deliveries": [], "pickup_eta": "2015-05-24T20:01:52Z", "dropoff_eta": "2015-05-24T20:31:10Z", "kind": "delivery"}, "id": "evt_KL7elPaMa3GucF"}`,
		`{"status": "pickup", "kind": "event.delivery_status", "created": "2015-05-24T19:47:17Z", "live_mode": false, "delivery_id": "del_KL7ebUwT4XjFKF", "data": {"status": "pickup", "dropoff": {"phone_number": "620-222-3333", "name": "Dropoff spot, Dropoff LLC", "notes": "Dropoff notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "updated": "2015-05-24T19:47:17Z", "fee": 1325, "quote_id": "dqt_KL7ebISPfySYZ-", "complete": false, "courier": {"phone_number": null, "img_href": "https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg", "vehicle_type": "scooter", "location": {"lat": 40.78861896295145, "lng": -73.99188127349834}, "name": "Pikachu R."}, "created": "2015-05-24T19:46:38Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "555-222-3333", "name": "Pickup spot, Pickup LLC", "notes": "Pickup notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL7ebUwT4XjFKF", "dropoff_deadline": "2015-05-24T20:46:37Z", "related_deliveries": [], "pickup_eta": "2015-05-24T20:09:09Z", "dropoff_eta": "2015-05-24T20:45:43Z", "kind": "delivery"}, "id": "evt_KL7elR_sFyDrXV"}`,
		`{"kind": "event.courier_update", "location": {"lat": 40.7645362057562, "lng": -74.00077445488816}, "created": "2015-05-24T19:47:27Z", "live_mode": false, "delivery_id": "del_KL7ebUwT4XjFKF", "data": {"status": "pickup", "dropoff": {"phone_number": "620-222-3333", "name": "Dropoff spot, Dropoff LLC", "notes": "Dropoff notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "updated": "2015-05-24T19:47:27Z", "fee": 1325, "quote_id": "dqt_KL7ebISPfySYZ-", "complete": false, "courier": {"phone_number": null, "img_href": "https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg", "vehicle_type": "scooter", "location": {"lat": 40.7645362057562, "lng": -74.00077445488816}, "name": "Pikachu R."}, "created": "2015-05-24T19:46:38Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "555-222-3333", "name": "Pickup spot, Pickup LLC", "notes": "Pickup notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL7ebUwT4XjFKF", "dropoff_deadline": "2015-05-24T20:46:37Z", "related_deliveries": [], "pickup_eta": "2015-05-24T19:57:09Z", "dropoff_eta": "2015-05-24T20:21:34Z", "kind": "delivery"}, "id": "evt_KL7enuygQwCV_F"}`,
		`{"kind": "event.courier_update", "location": {"lat": 40.7581141371708, "lng": -74.00314596992544}, "created": "2015-05-24T19:47:37Z", "live_mode": false, "delivery_id": "del_KL7ebUwT4XjFKF", "data": {"status": "pickup", "dropoff": {"phone_number": "620-222-3333", "name": "Dropoff spot, Dropoff LLC", "notes": "Dropoff notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "updated": "2015-05-24T19:47:37Z", "fee": 1325, "quote_id": "dqt_KL7ebISPfySYZ-", "complete": false, "courier": {"phone_number": null, "img_href": "https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg", "vehicle_type": "scooter", "location": {"lat": 40.7581141371708, "lng": -74.00314596992544}, "name": "Pikachu R."}, "created": "2015-05-24T19:46:38Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "555-222-3333", "name": "Pickup spot, Pickup LLC", "notes": "Pickup notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL7ebUwT4XjFKF", "dropoff_deadline": "2015-05-24T20:46:37Z", "related_deliveries": [], "pickup_eta": "2015-05-24T19:54:06Z", "dropoff_eta": "2015-05-24T20:15:17Z", "kind": "delivery"}, "id": "evt_KL7eqGhXyBArBV"}`,
		`{"kind": "event.courier_update", "location": {"lat": 40.74527, "lng": -74.007889}, "created": "2015-05-24T19:47:47Z", "live_mode": false, "delivery_id": "del_KL7ebUwT4XjFKF", "data": {"status": "pickup", "dropoff": {"phone_number": "620-222-3333", "name": "Dropoff spot, Dropoff LLC", "notes": "Dropoff notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "updated": "2015-05-24T19:47:47Z", "fee": 1325, "quote_id": "dqt_KL7ebISPfySYZ-", "complete": false, "courier": {"phone_number": null, "img_href": "https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg", "vehicle_type": "scooter", "location": {"lat": 40.74527, "lng": -74.007889}, "name": "Pikachu R."}, "created": "2015-05-24T19:46:38Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "555-222-3333", "name": "Pickup spot, Pickup LLC", "notes": "Pickup notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL7ebUwT4XjFKF", "dropoff_deadline": "2015-05-24T20:46:37Z", "related_deliveries": [], "pickup_eta": "2015-05-24T19:47:47Z", "dropoff_eta": "2015-05-24T20:02:29Z", "kind": "delivery"}, "id": "evt_KL7estbt3giVh-"}`,
		`{"kind": "event.courier_update", "location": {"lat": 40.74527, "lng": -74.007889}, "created": "2015-05-24T19:47:57Z", "live_mode": false, "delivery_id": "del_KL7ebUwT4XjFKF", "data": {"status": "pickup", "dropoff": {"phone_number": "620-222-3333", "name": "Dropoff spot, Dropoff LLC", "notes": "Dropoff notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "updated": "2015-05-24T19:47:47Z", "fee": 1325, "quote_id": "dqt_KL7ebISPfySYZ-", "complete": false, "courier": {"phone_number": null, "img_href": "https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg", "vehicle_type": "scooter", "location": {"lat": 40.74527, "lng": -74.007889}, "name": "Pikachu R."}, "created": "2015-05-24T19:46:38Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "555-222-3333", "name": "Pickup spot, Pickup LLC", "notes": "Pickup notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL7ebUwT4XjFKF", "dropoff_deadline": "2015-05-24T20:46:37Z", "related_deliveries": [], "pickup_eta": "2015-05-24T19:47:47Z", "dropoff_eta": "2015-05-24T20:02:29Z", "kind": "delivery"}, "id": "evt_KL7evLGlh8JDr-"}`,
		`{"status": "pickup_complete", "kind": "event.delivery_status", "created": "2015-05-24T19:47:57Z", "live_mode": false, "delivery_id": "del_KL7ebUwT4XjFKF", "data": {"status": "pickup_complete", "dropoff": {"phone_number": "620-222-3333", "name": "Dropoff spot, Dropoff LLC", "notes": "Dropoff notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "updated": "2015-05-24T19:47:57Z", "fee": 1325, "quote_id": "dqt_KL7ebISPfySYZ-", "complete": false, "courier": {"phone_number": null, "img_href": "https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg", "vehicle_type": "scooter", "location": {"lat": 40.74527, "lng": -74.007889}, "name": "Pikachu R."}, "created": "2015-05-24T19:46:38Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "555-222-3333", "name": "Pickup spot, Pickup LLC", "notes": "Pickup notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL7ebUwT4XjFKF", "dropoff_deadline": "2015-05-24T20:46:37Z", "related_deliveries": [], "pickup_eta": null, "dropoff_eta": "2015-05-24T20:02:29Z", "kind": "delivery"}, "id": "evt_KL7evOzgXv2QSV"}`,
		`{"status": "dropoff", "kind": "event.delivery_status", "created": "2015-05-24T19:48:17Z", "live_mode": false, "delivery_id": "del_KL7ebUwT4XjFKF", "data": {"status": "dropoff", "dropoff": {"phone_number": "620-222-3333", "name": "Dropoff spot, Dropoff LLC", "notes": "Dropoff notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "updated": "2015-05-24T19:48:17Z", "fee": 1325, "quote_id": "dqt_KL7ebISPfySYZ-", "complete": false, "courier": {"phone_number": null, "img_href": "https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg", "vehicle_type": "scooter", "location": {"lat": 40.74527, "lng": -74.007889}, "name": "Pikachu R."}, "created": "2015-05-24T19:46:38Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "555-222-3333", "name": "Pickup spot, Pickup LLC", "notes": "Pickup notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL7ebUwT4XjFKF", "dropoff_deadline": "2015-05-24T20:46:37Z", "related_deliveries": [], "pickup_eta": null, "dropoff_eta": "2015-05-24T19:58:00Z", "kind": "delivery"}, "id": "evt_KL7f-QxpgSJUCV"}`,
		`{"kind": "event.courier_update", "location": {"lat": 40.747101666666666, "lng": -74.004991}, "created": "2015-05-24T19:48:17Z", "live_mode": false, "delivery_id": "del_KL7ebUwT4XjFKF", "data": {"status": "dropoff", "dropoff": {"phone_number": "620-222-3333", "name": "Dropoff spot, Dropoff LLC", "notes": "Dropoff notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "updated": "2015-05-24T19:48:17Z", "fee": 1325, "quote_id": "dqt_KL7ebISPfySYZ-", "complete": false, "courier": {"phone_number": null, "img_href": "https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg", "vehicle_type": "scooter", "location": {"lat": 40.747101666666666, "lng": -74.004991}, "name": "Pikachu R."}, "created": "2015-05-24T19:46:38Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "555-222-3333", "name": "Pickup spot, Pickup LLC", "notes": "Pickup notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL7ebUwT4XjFKF", "dropoff_deadline": "2015-05-24T20:46:37Z", "related_deliveries": [], "pickup_eta": null, "dropoff_eta": "2015-05-24T19:56:22Z", "kind": "delivery"}, "id": "evt_KL7f-GHuB9UIck"}`,
		`{"kind": "event.courier_update", "location": {"lat": 40.74862805555556, "lng": -74.002576}, "created": "2015-05-24T19:48:27Z", "live_mode": false, "delivery_id": "del_KL7ebUwT4XjFKF", "data": {"status": "dropoff", "dropoff": {"phone_number": "620-222-3333", "name": "Dropoff spot, Dropoff LLC", "notes": "Dropoff notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "updated": "2015-05-24T19:48:27Z", "fee": 1325, "quote_id": "dqt_KL7ebISPfySYZ-", "complete": false, "courier": {"phone_number": null, "img_href": "https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg", "vehicle_type": "scooter", "location": {"lat": 40.74862805555556, "lng": -74.002576}, "name": "Pikachu R."}, "created": "2015-05-24T19:46:38Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "555-222-3333", "name": "Pickup spot, Pickup LLC", "notes": "Pickup notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL7ebUwT4XjFKF", "dropoff_deadline": "2015-05-24T20:46:37Z", "related_deliveries": [], "pickup_eta": null, "dropoff_eta": "2015-05-24T19:55:10Z", "kind": "delivery"}, "id": "evt_KL7f1qGeGVC0Rk"}`,
		`{"kind": "event.courier_update", "location": {"lat": 40.7499000462963, "lng": -74.0005635}, "created": "2015-05-24T19:48:37Z", "live_mode": false, "delivery_id": "del_KL7ebUwT4XjFKF", "data": {"status": "dropoff", "dropoff": {"phone_number": "620-222-3333", "name": "Dropoff spot, Dropoff LLC", "notes": "Dropoff notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "updated": "2015-05-24T19:48:37Z", "fee": 1325, "quote_id": "dqt_KL7ebISPfySYZ-", "complete": false, "courier": {"phone_number": null, "img_href": "https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg", "vehicle_type": "scooter", "location": {"lat": 40.7499000462963, "lng": -74.0005635}, "name": "Pikachu R."}, "created": "2015-05-24T19:46:38Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "555-222-3333", "name": "Pickup spot, Pickup LLC", "notes": "Pickup notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL7ebUwT4XjFKF", "dropoff_deadline": "2015-05-24T20:46:37Z", "related_deliveries": [], "pickup_eta": null, "dropoff_eta": "2015-05-24T19:54:13Z", "kind": "delivery"}, "id": "evt_KL7f4I4HQj2LNF"}`,
		`{"kind": "event.courier_update", "location": {"lat": 40.75626, "lng": -73.990501}, "created": "2015-05-24T19:48:47Z", "live_mode": false, "delivery_id": "del_KL7ebUwT4XjFKF", "data": {"status": "dropoff", "dropoff": {"phone_number": "620-222-3333", "name": "Dropoff spot, Dropoff LLC", "notes": "Dropoff notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "updated": "2015-05-24T19:48:47Z", "fee": 1325, "quote_id": "dqt_KL7ebISPfySYZ-", "complete": false, "courier": {"phone_number": null, "img_href": "https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg", "vehicle_type": "scooter", "location": {"lat": 40.75626, "lng": -73.990501}, "name": "Pikachu R."}, "created": "2015-05-24T19:46:38Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "555-222-3333", "name": "Pickup spot, Pickup LLC", "notes": "Pickup notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL7ebUwT4XjFKF", "dropoff_deadline": "2015-05-24T20:46:37Z", "related_deliveries": [], "pickup_eta": null, "dropoff_eta": "2015-05-24T19:48:47Z", "kind": "delivery"}, "id": "evt_KL7f6yGSnJnXyk"}`,
		`{"kind": "event.courier_update", "location": {"lat": 40.75626, "lng": -73.990501}, "created": "2015-05-24T19:48:57Z", "live_mode": false, "delivery_id": "del_KL7ebUwT4XjFKF", "data": {"status": "dropoff", "dropoff": {"phone_number": "620-222-3333", "name": "Dropoff spot, Dropoff LLC", "notes": "Dropoff notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "updated": "2015-05-24T19:48:47Z", "fee": 1325, "quote_id": "dqt_KL7ebISPfySYZ-", "complete": false, "courier": {"phone_number": null, "img_href": "https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg", "vehicle_type": "scooter", "location": {"lat": 40.75626, "lng": -73.990501}, "name": "Pikachu R."}, "created": "2015-05-24T19:46:38Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "555-222-3333", "name": "Pickup spot, Pickup LLC", "notes": "Pickup notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL7ebUwT4XjFKF", "dropoff_deadline": "2015-05-24T20:46:37Z", "related_deliveries": [], "pickup_eta": null, "dropoff_eta": "2015-05-24T19:48:47Z", "kind": "delivery"}, "id": "evt_KL7f9GWP6AWpZF"}`,
		`{"status": "delivered", "kind": "event.delivery_status", "created": "2015-05-24T19:48:57Z", "live_mode": false, "delivery_id": "del_KL7ebUwT4XjFKF", "data": {"status": "delivered", "dropoff": {"phone_number": "620-222-3333", "name": "Dropoff spot, Dropoff LLC", "notes": "Dropoff notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "updated": "2015-05-24T19:48:57Z", "fee": 1325, "quote_id": "dqt_KL7ebISPfySYZ-", "complete": true, "courier": null, "created": "2015-05-24T19:46:38Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "555-222-3333", "name": "Pickup spot, Pickup LLC", "notes": "Pickup notes", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL7ebUwT4XjFKF", "dropoff_deadline": "2015-05-24T20:46:37Z", "related_deliveries": [], "pickup_eta": null, "dropoff_eta": null, "kind": "delivery"}, "id": "evt_KL7f9KncOO-Zik"}`,

		// extra payloads from other tests
		`{"kind": "event.delivery_return", "status": "pending", "created": "2015-05-24T22:09:01Z", "live_mode": false, "delivery_id": "del_KL8AzNm555V35F", "data": {"status": "pending", "dropoff": {"phone_number": "555-222-3333", "name": "Pickup spot", "notes": "", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "updated": "2015-05-24T22:09:01Z", "fee": 1325, "quote_id": "dqt_KL8AzO3DtWMZVk", "complete": false, "courier": null, "created": "2015-05-24T22:09:01Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "620-222-3333", "name": "Dropoff spot", "notes": "", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL8AzNm555V35F", "dropoff_deadline": "2015-05-24T23:10:01Z", "related_deliveries": [{"id": "del_KL8AWnVDpTQ3nF", "relationship": "original"}], "pickup_eta": null, "dropoff_eta": null, "kind": "delivery"}, "id": "evt_KL8AzKO3F34Kq-"}`,
		`{"kind": "event.delivery_deadline", "dropoff_deadline": "2015-05-24T22:09:01Z", "created": "2015-05-24T22:09:01Z", "live_mode": false, "delivery_id": "del_KL8AzNm555V35F", "data": {"status": "pending", "dropoff": {"phone_number": "555-222-3333", "name": "Pickup spot", "notes": "", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "555 W 18th St", "street_address_2": "", "state": "NY", "zip_code": "10011"}, "location": {"lat": 40.74527, "lng": -74.007889}, "address": "555 W 18th St"}, "updated": "2015-05-24T22:09:01Z", "fee": 1325, "quote_id": "dqt_KL8AzO3DtWMZVk", "complete": false, "courier": null, "created": "2015-05-24T22:09:01Z", "customer_signature_img_href": null, "manifest": {"description": "Manifest description", "reference": "Manifest reference"}, "currency": "usd", "pickup": {"phone_number": "620-222-3333", "name": "Dropoff spot", "notes": "", "detailed_address": {"city": "New York", "country": "US", "street_address_1": "620 8th Ave", "street_address_2": "", "state": "NY", "zip_code": "10018"}, "location": {"lat": 40.75626, "lng": -73.990501}, "address": "620 8th Ave"}, "dropoff_identifier": "", "live_mode": false, "id": "del_KL8AzNm555V35F", "dropoff_deadline": "2015-05-24T23:10:01Z", "related_deliveries": [{"id": "del_KL8AWnVDpTQ3nF", "relationship": "original"}], "pickup_eta": null, "dropoff_eta": null, "kind": "delivery"}, "id": "evt_KL8AzKO3F34Kq-"}`,
	}
	TestDeliveryEventsJSON = []string{
		`{"id":"evt_KL7elPaMa3GucF","created":"2015-05-24T19:47:17Z","delivery_id":"del_KL7ebUwT4XjFKF","live_mode":false,"location":{"lat":40.7741693086343,"lng":-73.99721718233224},"data":{"kind":"delivery","id":"del_KL7ebUwT4XjFKF","status":"pickup","created":"2015-05-24T19:46:38Z","updated":"2015-05-24T19:47:17Z","dropoff_eta":"2015-05-24T20:31:10Z","pickup_eta":"2015-05-24T20:01:52Z","dropoff_deadline":"2015-05-24T20:46:37Z","complete":false,"courier":{"name":"Pikachu R.","img_href":"https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg","phone_number":"","vehicle_type":"scooter","location":{"lat":40.7741693086343,"lng":-73.99721718233224}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot, Dropoff LLC","notes":"Dropoff notes","phone_number":"620-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot, Pickup LLC","notes":"Pickup notes","phone_number":"555-222-3333"},"quote_id":"dqt_KL7ebISPfySYZ-","related_deliveries":[],"live_mode":false}}`,
		`{"id":"evt_KL7elR_sFyDrXV","created":"2015-05-24T19:47:17Z","delivery_id":"del_KL7ebUwT4XjFKF","live_mode":false,"status":"pickup","data":{"kind":"delivery","id":"del_KL7ebUwT4XjFKF","status":"pickup","created":"2015-05-24T19:46:38Z","updated":"2015-05-24T19:47:17Z","dropoff_eta":"2015-05-24T20:45:43Z","pickup_eta":"2015-05-24T20:09:09Z","dropoff_deadline":"2015-05-24T20:46:37Z","complete":false,"courier":{"name":"Pikachu R.","img_href":"https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg","phone_number":"","vehicle_type":"scooter","location":{"lat":40.78861896295145,"lng":-73.99188127349834}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot, Dropoff LLC","notes":"Dropoff notes","phone_number":"620-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot, Pickup LLC","notes":"Pickup notes","phone_number":"555-222-3333"},"quote_id":"dqt_KL7ebISPfySYZ-","related_deliveries":[],"live_mode":false}}`,
		`{"id":"evt_KL7enuygQwCV_F","created":"2015-05-24T19:47:27Z","delivery_id":"del_KL7ebUwT4XjFKF","live_mode":false,"location":{"lat":40.7645362057562,"lng":-74.00077445488816},"data":{"kind":"delivery","id":"del_KL7ebUwT4XjFKF","status":"pickup","created":"2015-05-24T19:46:38Z","updated":"2015-05-24T19:47:27Z","dropoff_eta":"2015-05-24T20:21:34Z","pickup_eta":"2015-05-24T19:57:09Z","dropoff_deadline":"2015-05-24T20:46:37Z","complete":false,"courier":{"name":"Pikachu R.","img_href":"https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg","phone_number":"","vehicle_type":"scooter","location":{"lat":40.7645362057562,"lng":-74.00077445488816}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot, Dropoff LLC","notes":"Dropoff notes","phone_number":"620-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot, Pickup LLC","notes":"Pickup notes","phone_number":"555-222-3333"},"quote_id":"dqt_KL7ebISPfySYZ-","related_deliveries":[],"live_mode":false}}`,
		`{"id":"evt_KL7eqGhXyBArBV","created":"2015-05-24T19:47:37Z","delivery_id":"del_KL7ebUwT4XjFKF","live_mode":false,"location":{"lat":40.7581141371708,"lng":-74.00314596992544},"data":{"kind":"delivery","id":"del_KL7ebUwT4XjFKF","status":"pickup","created":"2015-05-24T19:46:38Z","updated":"2015-05-24T19:47:37Z","dropoff_eta":"2015-05-24T20:15:17Z","pickup_eta":"2015-05-24T19:54:06Z","dropoff_deadline":"2015-05-24T20:46:37Z","complete":false,"courier":{"name":"Pikachu R.","img_href":"https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg","phone_number":"","vehicle_type":"scooter","location":{"lat":40.7581141371708,"lng":-74.00314596992544}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot, Dropoff LLC","notes":"Dropoff notes","phone_number":"620-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot, Pickup LLC","notes":"Pickup notes","phone_number":"555-222-3333"},"quote_id":"dqt_KL7ebISPfySYZ-","related_deliveries":[],"live_mode":false}}`,
		`{"id":"evt_KL7estbt3giVh-","created":"2015-05-24T19:47:47Z","delivery_id":"del_KL7ebUwT4XjFKF","live_mode":false,"location":{"lat":40.74527,"lng":-74.007889},"data":{"kind":"delivery","id":"del_KL7ebUwT4XjFKF","status":"pickup","created":"2015-05-24T19:46:38Z","updated":"2015-05-24T19:47:47Z","dropoff_eta":"2015-05-24T20:02:29Z","pickup_eta":"2015-05-24T19:47:47Z","dropoff_deadline":"2015-05-24T20:46:37Z","complete":false,"courier":{"name":"Pikachu R.","img_href":"https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg","phone_number":"","vehicle_type":"scooter","location":{"lat":40.74527,"lng":-74.007889}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot, Dropoff LLC","notes":"Dropoff notes","phone_number":"620-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot, Pickup LLC","notes":"Pickup notes","phone_number":"555-222-3333"},"quote_id":"dqt_KL7ebISPfySYZ-","related_deliveries":[],"live_mode":false}}`,
		`{"id":"evt_KL7evLGlh8JDr-","created":"2015-05-24T19:47:57Z","delivery_id":"del_KL7ebUwT4XjFKF","live_mode":false,"location":{"lat":40.74527,"lng":-74.007889},"data":{"kind":"delivery","id":"del_KL7ebUwT4XjFKF","status":"pickup","created":"2015-05-24T19:46:38Z","updated":"2015-05-24T19:47:47Z","dropoff_eta":"2015-05-24T20:02:29Z","pickup_eta":"2015-05-24T19:47:47Z","dropoff_deadline":"2015-05-24T20:46:37Z","complete":false,"courier":{"name":"Pikachu R.","img_href":"https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg","phone_number":"","vehicle_type":"scooter","location":{"lat":40.74527,"lng":-74.007889}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot, Dropoff LLC","notes":"Dropoff notes","phone_number":"620-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot, Pickup LLC","notes":"Pickup notes","phone_number":"555-222-3333"},"quote_id":"dqt_KL7ebISPfySYZ-","related_deliveries":[],"live_mode":false}}`,
		`{"id":"evt_KL7evOzgXv2QSV","created":"2015-05-24T19:47:57Z","delivery_id":"del_KL7ebUwT4XjFKF","live_mode":false,"status":"pickup_complete","data":{"kind":"delivery","id":"del_KL7ebUwT4XjFKF","status":"pickup_complete","created":"2015-05-24T19:46:38Z","updated":"2015-05-24T19:47:57Z","dropoff_eta":"2015-05-24T20:02:29Z","pickup_eta":null,"dropoff_deadline":"2015-05-24T20:46:37Z","complete":false,"courier":{"name":"Pikachu R.","img_href":"https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg","phone_number":"","vehicle_type":"scooter","location":{"lat":40.74527,"lng":-74.007889}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot, Dropoff LLC","notes":"Dropoff notes","phone_number":"620-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot, Pickup LLC","notes":"Pickup notes","phone_number":"555-222-3333"},"quote_id":"dqt_KL7ebISPfySYZ-","related_deliveries":[],"live_mode":false}}`,
		`{"id":"evt_KL7f-QxpgSJUCV","created":"2015-05-24T19:48:17Z","delivery_id":"del_KL7ebUwT4XjFKF","live_mode":false,"status":"dropoff","data":{"kind":"delivery","id":"del_KL7ebUwT4XjFKF","status":"dropoff","created":"2015-05-24T19:46:38Z","updated":"2015-05-24T19:48:17Z","dropoff_eta":"2015-05-24T19:58:00Z","pickup_eta":null,"dropoff_deadline":"2015-05-24T20:46:37Z","complete":false,"courier":{"name":"Pikachu R.","img_href":"https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg","phone_number":"","vehicle_type":"scooter","location":{"lat":40.74527,"lng":-74.007889}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot, Dropoff LLC","notes":"Dropoff notes","phone_number":"620-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot, Pickup LLC","notes":"Pickup notes","phone_number":"555-222-3333"},"quote_id":"dqt_KL7ebISPfySYZ-","related_deliveries":[],"live_mode":false}}`,
		`{"id":"evt_KL7f-GHuB9UIck","created":"2015-05-24T19:48:17Z","delivery_id":"del_KL7ebUwT4XjFKF","live_mode":false,"location":{"lat":40.747101666666666,"lng":-74.004991},"data":{"kind":"delivery","id":"del_KL7ebUwT4XjFKF","status":"dropoff","created":"2015-05-24T19:46:38Z","updated":"2015-05-24T19:48:17Z","dropoff_eta":"2015-05-24T19:56:22Z","pickup_eta":null,"dropoff_deadline":"2015-05-24T20:46:37Z","complete":false,"courier":{"name":"Pikachu R.","img_href":"https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg","phone_number":"","vehicle_type":"scooter","location":{"lat":40.747101666666666,"lng":-74.004991}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot, Dropoff LLC","notes":"Dropoff notes","phone_number":"620-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot, Pickup LLC","notes":"Pickup notes","phone_number":"555-222-3333"},"quote_id":"dqt_KL7ebISPfySYZ-","related_deliveries":[],"live_mode":false}}`,
		`{"id":"evt_KL7f1qGeGVC0Rk","created":"2015-05-24T19:48:27Z","delivery_id":"del_KL7ebUwT4XjFKF","live_mode":false,"location":{"lat":40.74862805555556,"lng":-74.002576},"data":{"kind":"delivery","id":"del_KL7ebUwT4XjFKF","status":"dropoff","created":"2015-05-24T19:46:38Z","updated":"2015-05-24T19:48:27Z","dropoff_eta":"2015-05-24T19:55:10Z","pickup_eta":null,"dropoff_deadline":"2015-05-24T20:46:37Z","complete":false,"courier":{"name":"Pikachu R.","img_href":"https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg","phone_number":"","vehicle_type":"scooter","location":{"lat":40.74862805555556,"lng":-74.002576}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot, Dropoff LLC","notes":"Dropoff notes","phone_number":"620-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot, Pickup LLC","notes":"Pickup notes","phone_number":"555-222-3333"},"quote_id":"dqt_KL7ebISPfySYZ-","related_deliveries":[],"live_mode":false}}`,
		`{"id":"evt_KL7f4I4HQj2LNF","created":"2015-05-24T19:48:37Z","delivery_id":"del_KL7ebUwT4XjFKF","live_mode":false,"location":{"lat":40.7499000462963,"lng":-74.0005635},"data":{"kind":"delivery","id":"del_KL7ebUwT4XjFKF","status":"dropoff","created":"2015-05-24T19:46:38Z","updated":"2015-05-24T19:48:37Z","dropoff_eta":"2015-05-24T19:54:13Z","pickup_eta":null,"dropoff_deadline":"2015-05-24T20:46:37Z","complete":false,"courier":{"name":"Pikachu R.","img_href":"https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg","phone_number":"","vehicle_type":"scooter","location":{"lat":40.7499000462963,"lng":-74.0005635}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot, Dropoff LLC","notes":"Dropoff notes","phone_number":"620-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot, Pickup LLC","notes":"Pickup notes","phone_number":"555-222-3333"},"quote_id":"dqt_KL7ebISPfySYZ-","related_deliveries":[],"live_mode":false}}`,
		`{"id":"evt_KL7f6yGSnJnXyk","created":"2015-05-24T19:48:47Z","delivery_id":"del_KL7ebUwT4XjFKF","live_mode":false,"location":{"lat":40.75626,"lng":-73.990501},"data":{"kind":"delivery","id":"del_KL7ebUwT4XjFKF","status":"dropoff","created":"2015-05-24T19:46:38Z","updated":"2015-05-24T19:48:47Z","dropoff_eta":"2015-05-24T19:48:47Z","pickup_eta":null,"dropoff_deadline":"2015-05-24T20:46:37Z","complete":false,"courier":{"name":"Pikachu R.","img_href":"https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg","phone_number":"","vehicle_type":"scooter","location":{"lat":40.75626,"lng":-73.990501}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot, Dropoff LLC","notes":"Dropoff notes","phone_number":"620-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot, Pickup LLC","notes":"Pickup notes","phone_number":"555-222-3333"},"quote_id":"dqt_KL7ebISPfySYZ-","related_deliveries":[],"live_mode":false}}`,
		`{"id":"evt_KL7f9GWP6AWpZF","created":"2015-05-24T19:48:57Z","delivery_id":"del_KL7ebUwT4XjFKF","live_mode":false,"location":{"lat":40.75626,"lng":-73.990501},"data":{"kind":"delivery","id":"del_KL7ebUwT4XjFKF","status":"dropoff","created":"2015-05-24T19:46:38Z","updated":"2015-05-24T19:48:47Z","dropoff_eta":"2015-05-24T19:48:47Z","pickup_eta":null,"dropoff_deadline":"2015-05-24T20:46:37Z","complete":false,"courier":{"name":"Pikachu R.","img_href":"https://d1725r39asqzt3.cloudfront.net/a9d42b88-dd63-4731-be26-8617fc738b93/orig.jpg","phone_number":"","vehicle_type":"scooter","location":{"lat":40.75626,"lng":-73.990501}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot, Dropoff LLC","notes":"Dropoff notes","phone_number":"620-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot, Pickup LLC","notes":"Pickup notes","phone_number":"555-222-3333"},"quote_id":"dqt_KL7ebISPfySYZ-","related_deliveries":[],"live_mode":false}}`,
		`{"id":"evt_KL7f9KncOO-Zik","created":"2015-05-24T19:48:57Z","delivery_id":"del_KL7ebUwT4XjFKF","live_mode":false,"status":"delivered","data":{"kind":"delivery","id":"del_KL7ebUwT4XjFKF","status":"delivered","created":"2015-05-24T19:46:38Z","updated":"2015-05-24T19:48:57Z","dropoff_eta":null,"pickup_eta":null,"dropoff_deadline":"2015-05-24T20:46:37Z","complete":true,"courier":{"name":"","img_href":"","phone_number":"","vehicle_type":"","location":{"lat":0,"lng":0}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot, Dropoff LLC","notes":"Dropoff notes","phone_number":"620-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot, Pickup LLC","notes":"Pickup notes","phone_number":"555-222-3333"},"quote_id":"dqt_KL7ebISPfySYZ-","related_deliveries":[],"live_mode":false}}`,

		// extra payloads from other tests
		`{"id":"evt_KL8AzKO3F34Kq-","created":"2015-05-24T22:09:01Z","delivery_id":"del_KL8AzNm555V35F","live_mode":false,"status":"pending","data":{"kind":"delivery","id":"del_KL8AzNm555V35F","status":"pending","created":"2015-05-24T22:09:01Z","updated":"2015-05-24T22:09:01Z","dropoff_eta":null,"pickup_eta":null,"dropoff_deadline":"2015-05-24T23:10:01Z","complete":false,"courier":{"name":"","img_href":"","phone_number":"","vehicle_type":"","location":{"lat":0,"lng":0}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot","notes":"","phone_number":"555-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot","notes":"","phone_number":"620-222-3333"},"quote_id":"dqt_KL8AzO3DtWMZVk","related_deliveries":[{"id":"del_KL8AWnVDpTQ3nF","relationship":"original"}],"live_mode":false}}`,
		`{"id":"evt_KL8AzKO3F34Kq-","created":"2015-05-24T22:09:01Z","delivery_id":"del_KL8AzNm555V35F","live_mode":false,"dropoff_deadline":"2015-05-24T22:09:01Z","data":{"kind":"delivery","id":"del_KL8AzNm555V35F","status":"pending","created":"2015-05-24T22:09:01Z","updated":"2015-05-24T22:09:01Z","dropoff_eta":null,"pickup_eta":null,"dropoff_deadline":"2015-05-24T23:10:01Z","complete":false,"courier":{"name":"","img_href":"","phone_number":"","vehicle_type":"","location":{"lat":0,"lng":0}},"currency":"usd","customer_signature_img_href":"","dropoff":{"address":"555 W 18th St","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"555 W 18th St","street_address_2":"","zip_code":"10011"},"location":{"lat":40.74527,"lng":-74.007889},"name":"Pickup spot","notes":"","phone_number":"555-222-3333"},"dropoff_identifier":"","fee":1325,"manifest":{"description":"Manifest description","reference":"Manifest reference"},"pickup":{"address":"620 8th Ave","detailed_address":{"city":"New York","country":"US","state":"NY","street_address_1":"620 8th Ave","street_address_2":"","zip_code":"10018"},"location":{"lat":40.75626,"lng":-73.990501},"name":"Dropoff spot","notes":"","phone_number":"620-222-3333"},"quote_id":"dqt_KL8AzO3DtWMZVk","related_deliveries":[{"id":"del_KL8AWnVDpTQ3nF","relationship":"original"}],"live_mode":false}}`,
	}
)

func TestWebhook(t *testing.T) {

	var (
		wh     = NewWebhook()
		s      = httptest.NewServer(wh.Handler)
		events = make(chan interface{}, len(TestDeliveryPayloads))
	)

	defer s.Close()

	go func() {
		for i := 0; i < len(TestDeliveryPayloads); i++ {
			select {
			case e := <-wh.Events.DeliveryStatus:
				events <- e
			case e := <-wh.Events.DeliveryDeadline:
				if len(e.Delivery.RelatedDeliveries) == 0 {
					t.Errorf("Expected a related delivery in this event")
				}
				events <- e
			case e := <-wh.Events.CourierUpdate:
				events <- e
			case e := <-wh.Events.DeliveryReturn:
				if len(e.Delivery.RelatedDeliveries) == 0 {
					t.Errorf("Expected a related delivery in this event")
				}
				events <- e
			}
		}
	}()

	// give the test server a sec to spin up.
	time.Sleep(100 * time.Millisecond)

	for i, payload := range TestDeliveryPayloads {
		resp, err := http.Post(s.URL, "application/json; charset=UTF-8", strings.NewReader(payload))
		if err != nil {
			t.Error(err)
		}
		if resp.StatusCode != http.StatusOK {
			data, _ := ioutil.ReadAll(resp.Body)
			resp.Body.Close()
			t.Errorf("Expected %q, got %q (%s)", http.StatusText(http.StatusOK), resp.Status, bytes.TrimRight(data, "\n"))
			break
		}

		e := <-events
		buf := &bytes.Buffer{}
		json.NewEncoder(buf).Encode(e)
		data := bytes.TrimRight(buf.Bytes(), "\n")
		if !bytes.Equal(data, []byte(TestDeliveryEventsJSON[i])) {
			t.Errorf("Event payload mismatch!")
			fmt.Printf("%s\n---\n%s\n\n", data, TestDeliveryEventsJSON[i])
		}
	}

}

func TestWebhookUnsupported(t *testing.T) {

	var (
		wh = NewWebhook()
		s  = httptest.NewServer(wh.Handler)
	)

	defer s.Close()

	// give the test server a sec to spin up.
	time.Sleep(100 * time.Millisecond)

	// POST is the only supported method
	resp, err := http.Get(s.URL)
	if err != nil {
		t.Error(err)
	}
	if resp.StatusCode != http.StatusMethodNotAllowed {
		t.Errorf("Expected %d, got %d", http.StatusMethodNotAllowed, resp.StatusCode)
	}

	// test junk kind
	resp, err = http.Post(s.URL, "application/json; charset=UTF-8", strings.NewReader(`{"kind":"xxx"}`))
	if err != nil {
		t.Error(err)
	}
	if resp.StatusCode != http.StatusBadRequest {
		t.Errorf("Expected %d, got %d", http.StatusBadRequest, resp.StatusCode)
	}
	if data, err := ioutil.ReadAll(resp.Body); err != nil {
		t.Error(err)
	} else if !bytes.Equal(bytes.TrimRight(data, "\n"), []byte(ErrUnsupportedEventKind.Error())) {
		t.Errorf("Expected %q, got %q", ErrUnsupportedEventKind.Error(), data)
	}

}
